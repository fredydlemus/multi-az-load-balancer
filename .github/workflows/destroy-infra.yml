name: Destroy Infrastructure

on:
    workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
    destroy:
        name: Destroy Infrastructure
        runs-on: ubuntu-latest
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          STATE_BUCKET: ${{ vars.STATE_BUCKET }}
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
        
        - name: Configure AWS Credentials
          uses:  aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
            role-session-name: GitHubActionsSession
            aws-region: ${{ env.AWS_REGION }}

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
              terraform_version: "1.7.0"

        - name: Terraform Init
          run: |
            terraform init \
                -backend-config="bucket=$STATE_BUCKET" \
                -backend-config="region=$AWS_REGION"
          env:
            STATE_BUCKET: ${{ env.STATE_BUCKET }}
            AWS_REGION: ${{ env.AWS_REGION }}

        - name: Terraform Validate
          run: terraform validate

        - name: Terraform destroy
          run: |
            terraform destroy -auto-approve \
            -var="hosted_zone_id=${{secrets.HOSTED_ZONE_ID}}" \
            -var="record_name=${{vars.RECORD_NAME}}"